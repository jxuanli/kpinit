#include "io_helpers.h"
#include <errno.h>
#include <stdarg.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

char *ANSI_BRIGHT_GREEN = "\033[32;1m";
char *ANSI_YELLOW = "\033[33m";
char *ANSI_BLUE = "\033[34m";
char *ANSI_RED = "\033[31m";
char *ANSI_RESET = "\033[0m";

void vcprintf(const char *c, char *prefix, const char *format, va_list args) {
  printf("%s%s", c, prefix);
  vprintf(format, args);
  printf("%s\n", ANSI_RESET);
}

#define GENERATE_VCPRINTF(prefix, c)                                           \
  va_list args;                                                                \
  va_start(args, fmt);                                                         \
  vcprintf(c, prefix, fmt, args);                                              \
  va_end(args);                                                                \
  fflush(stdout);

void important(const char *fmt, ...) {
  //
  GENERATE_VCPRINTF("[!] ", ANSI_BRIGHT_GREEN);
}

void info(const char *fmt, ...) {
  //
  GENERATE_VCPRINTF("[+] ", ANSI_BLUE);
}

void warn(const char *fmt, ...) {
  //
  GENERATE_VCPRINTF("[*] ", ANSI_YELLOW);
}

void error(const char *fmt, ...) {
  GENERATE_VCPRINTF("[-] ", ANSI_RED);
  exit(-1);
}

void hexdump(void *addr, size_t len) {
  printf("=== HEXDUMP [%p - %p] ===\n", addr, addr + len);
  int size = len;
  for (int i = 0; i < size; i += 0x10) {
    printf("%s0x%lx%s:     ", ANSI_BLUE, (ulong)(addr + i), ANSI_RESET);
    printf("0x%016lx      ", *(ulong *)(addr + i));
    printf("0x%016lx\n", *(ulong *)(addr + i + 8));
  }
  puts("==========");
}

u64 input(const char *fmt, ...) {
  char buf[0x10] = {0};
  long res = 0;
  GENERATE_VCPRINTF("[Input] ", ANSI_BRIGHT_GREEN);
  int len = read(0, buf, sizeof(buf));
  buf[len] = 0;
  res = atol(buf);
  return res;
}

void checkf(int cond, char *msg) {
  if (!cond) {
    error("%s (reason: %s)", msg, strerror(errno));
  }
}

i32 checkw(int cond, char *msg) {
  if (!cond) {
    warn("%s (reason: %s)", msg, strerror(errno));
    return 1;
  }
  return 0;
}

char charset[26] = "abcdefghijklmnopqrstuvwxyz";
void db(int t, int p, int n, int *a, char *buf, int size) {
  if (strlen(buf) == size)
    return;
  if (t > n) {
    if (n % p == 0) {
      int buflen = strlen(buf);
      for (int i = 1; i <= p; i++) {
        buf[buflen++] = charset[a[i]];
        if (buflen == size)
          return;
      }
    }
  } else {
    a[t] = a[t - p];
    db(t + 1, p, n, a, buf, size);
    for (int i = a[t - p] + 1; i < sizeof(charset); i++) {
      a[t] = i;
      db(t + 1, t, n, a, buf, size);
    }
  }
}

char *cyclic(char *buf, int size) {
  int n = 4;
  int *a = calloc(sizeof(int), sizeof(charset) * n);
  if (buf != 0)
    buf = malloc(size + 1);
  db(1, 1, n, a, buf, size);
  return buf;
}
