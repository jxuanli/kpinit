#include "types.h"
#include <linux/bpf.h>
#include <sys/syscall.h>
#include <unistd.h>

int bpf(int cmd, void *attr) {
  return syscall(SYS_bpf, cmd, attr, sizeof(union bpf_attr));
}

int bpf_prog_load(enum bpf_prog_type type, const struct bpf_insn *insns,
                  int cnt, u64 buf, u64 buf_sz) {
  char *lisence = "GPL";
  union bpf_attr attr = {
      .prog_type = type,
      .insns = (u64)insns,
      .insn_cnt = cnt,
      .license = (u64)lisence,
      .log_buf = buf,
      .log_size = buf_sz,
      .log_level = 1,
  };
  return bpf(BPF_PROG_LOAD, &attr);
}

int bpf_create_map(enum bpf_map_type map_type, unsigned int key_size,
                   unsigned int value_size, unsigned int max_entries) {
  union bpf_attr attr = {.map_type = map_type,
                         .key_size = key_size,
                         .value_size = value_size,
                         .max_entries = max_entries};

  return bpf(BPF_MAP_CREATE, &attr);
}

int update_map_element(int map_fd, u64 key, void *value, u64 flags) {
  int ret = -1;

  union bpf_attr attr = {
      .map_fd = map_fd,
      .key = (u64)&key,
      .value = (u64)value,
      .flags = flags,
  };

  return bpf(BPF_MAP_UPDATE_ELEM, &attr);
}

int lookup_map_element(int map_fd, u64 key, void *value) {
  int ret = -1;
  union bpf_attr attr = {
      .map_fd = map_fd,
      .key = (u64)&key,
      .value = (u64)value,
  };

  return bpf(BPF_MAP_LOOKUP_ELEM, &attr);
}

int delete_map_element(int map_fd, u64 key) {
  int ret = -1;
  union bpf_attr attr = {
      .map_fd = map_fd,
      .key = (u64)&key,
  };

  return bpf(BPF_MAP_DELETE_ELEM, &attr);
}
